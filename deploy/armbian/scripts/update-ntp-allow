#!/usr/bin/env bash
set -euo pipefail
DEV=${1:-end0}
sub4=$(ip -4 -o addr show dev "$DEV" | awk '{print $4}' | head -n1 || true)
sub6=$(ip -6 -o addr show dev "$DEV" | awk '{print $4}' | head -n1 || true)

# chrony allow file
{
  echo "# Generated by update-ntp-allow for $DEV"
  if [ -n "$sub4" ]; then echo "allow $sub4"; fi
  if [ -n "$sub6" ]; then echo "allow $sub6"; fi
} > /etc/chrony/allow.conf.tmp
mv /etc/chrony/allow.conf.tmp /etc/chrony/allow.conf

# nftables config restricted to end0 subnets
cat > /etc/nftables.conf <<NFT
flush ruleset

table inet filter {
  chain input {
    type filter hook input priority 0; policy drop;

    ct state established,related accept
    iif lo accept

    tcp dport { 22, 8000 } accept
NFT

if [ -n "$sub4" ]; then
  echo "    iif \"$DEV\" ip saddr $sub4 udp dport 123 accept" >> /etc/nftables.conf
fi
if [ -n "$sub6" ]; then
  echo "    iif \"$DEV\" ip6 saddr $sub6 udp dport 123 accept" >> /etc/nftables.conf
fi

cat >> /etc/nftables.conf <<'NFT'

    ip protocol icmp accept
    ip6 nexthdr ipv6-icmp accept
  }

  chain forward { type filter hook forward priority 0; policy drop; }
  chain output  { type filter hook output  priority 0; policy accept; }
}
NFT

# Apply firewall and reload chrony
nft -f /etc/nftables.conf
systemctl enable --now nftables >/dev/null 2>&1 || true
systemctl reload chrony 2>/dev/null || systemctl restart chrony 2>/dev/null || true

printf 'Updated NTP allow to: IPv4=%s IPv6=%s on dev=%s\n' "${sub4:-none}" "${sub6:-none}" "$DEV"
